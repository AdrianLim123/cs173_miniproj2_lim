{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nimport { crypto_secretbox_NONCEBYTES, crypto_secretbox_MACBYTES } from 'libsodium-wrappers';\nimport { windowRef, Serializer, getSenderId, MessageBasedClient } from '@airgap/beacon-core';\nimport { openCryptobox } from '@airgap/beacon-utils';\nimport { ExtensionMessageTarget, Origin } from '@airgap/beacon-types';\n/**\n * @internalapi\n *\n *\n */\nexport class PostMessageClient extends MessageBasedClient {\n  constructor() {\n    super(...arguments);\n    this.activeListeners = new Map();\n  }\n  init() {\n    return __awaiter(this, void 0, void 0, function* () {\n      this.subscribeToMessages().catch(console.error);\n    });\n  }\n  listenForEncryptedMessage(senderPublicKey, messageCallback) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this.activeListeners.has(senderPublicKey)) {\n        return;\n      }\n      const callbackFunction = (message, context) => __awaiter(this, void 0, void 0, function* () {\n        try {\n          const decryptedMessage = yield this.decryptMessage(senderPublicKey, message.encryptedPayload);\n          // console.log('calculated sender ID', await getSenderId(senderPublicKey))\n          // TODO: Add check for correct decryption key / sender ID\n          messageCallback(decryptedMessage, context);\n        } catch (decryptionError) {\n          /* NO-OP. We try to decode every message, but some might not be addressed to us. */\n        }\n      });\n      this.activeListeners.set(senderPublicKey, callbackFunction);\n    });\n  }\n  sendMessage(message, peer) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function* () {\n      const payload = yield this.encryptMessage(peer.publicKey, message);\n      const targetId = (_a = peer) === null || _a === void 0 ? void 0 : _a.extensionId;\n      // if no targetId, we remove peer\n      const msg = {\n        target: ExtensionMessageTarget.EXTENSION,\n        encryptedPayload: payload,\n        targetId\n      };\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      windowRef.postMessage(msg, windowRef.location.origin);\n    });\n  }\n  listenForChannelOpening(messageCallback) {\n    return __awaiter(this, void 0, void 0, function* () {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const fn = event => __awaiter(this, void 0, void 0, function* () {\n        var _a, _b;\n        if (event.source !== windowRef || event.origin !== windowRef.location.origin) {\n          // TODO: Add to error handler: console.debug('[Beacon]: Event received from untrusted origin')\n          return;\n        }\n        const data = (_a = event === null || event === void 0 ? void 0 : event.data) === null || _a === void 0 ? void 0 : _a.message;\n        if (data && data.target === ExtensionMessageTarget.PAGE && (yield this.isChannelOpenMessage(data))) {\n          const payload = Buffer.from(data.payload, 'hex');\n          if (payload.length >= crypto_secretbox_NONCEBYTES + crypto_secretbox_MACBYTES) {\n            try {\n              const pairingResponse = JSON.parse(yield openCryptobox(payload, this.keyPair.publicKey, this.keyPair.privateKey));\n              messageCallback(Object.assign(Object.assign({}, pairingResponse), {\n                senderId: yield getSenderId(pairingResponse.publicKey),\n                extensionId: (_b = event === null || event === void 0 ? void 0 : event.data) === null || _b === void 0 ? void 0 : _b.sender.id\n              }));\n            } catch (decryptionError) {\n              /* NO-OP. We try to decode every message, but some might not be addressed to us. */\n            }\n          }\n        }\n      });\n      windowRef.addEventListener('message', fn);\n    });\n  }\n  sendPairingRequest(id) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const message = {\n        target: ExtensionMessageTarget.EXTENSION,\n        payload: yield new Serializer().serialize(yield this.getPairingRequestInfo()),\n        targetId: id\n      };\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      windowRef.postMessage(message, windowRef.location.origin);\n    });\n  }\n  isChannelOpenMessage(message) {\n    return __awaiter(this, void 0, void 0, function* () {\n      return typeof message === 'object' && message.hasOwnProperty('payload');\n    });\n  }\n  subscribeToMessages() {\n    return __awaiter(this, void 0, void 0, function* () {\n      windowRef.addEventListener('message', message => {\n        if (message.source !== windowRef || message.origin !== windowRef.location.origin) {\n          // TODO: Add to error handler: console.debug('[Beacon]: Event received from untrusted origin')\n          return;\n        }\n        if (typeof message === 'object' && message) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          const data = message.data;\n          if (data.message && data.message.target === ExtensionMessageTarget.PAGE) {\n            this.activeListeners.forEach(listener => {\n              listener(data.message, {\n                origin: Origin.EXTENSION,\n                id: data.sender.id || ''\n              });\n            });\n          }\n        }\n      });\n    });\n  }\n}","map":{"version":3,"names":["crypto_secretbox_NONCEBYTES","crypto_secretbox_MACBYTES","windowRef","Serializer","getSenderId","MessageBasedClient","openCryptobox","ExtensionMessageTarget","Origin","PostMessageClient","constructor","activeListeners","Map","init","subscribeToMessages","catch","console","error","listenForEncryptedMessage","senderPublicKey","messageCallback","has","callbackFunction","message","context","__awaiter","decryptedMessage","decryptMessage","encryptedPayload","decryptionError","set","sendMessage","peer","payload","encryptMessage","publicKey","targetId","_a","extensionId","msg","target","EXTENSION","postMessage","location","origin","listenForChannelOpening","fn","event","source","data","PAGE","isChannelOpenMessage","Buffer","from","length","pairingResponse","JSON","parse","keyPair","privateKey","Object","assign","senderId","_b","sender","id","addEventListener","sendPairingRequest","serialize","getPairingRequestInfo","hasOwnProperty","forEach","listener"],"sources":["../../src/PostMessageClient.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module"}